import{r as b}from"./rope-sequence.7d68748c.js";import{M as k}from"./prosemirror-transform.ac9e639a.js";import{P as O,a as D}from"./prosemirror-state.334938da.js";var R=500,l=function(n,e){this.items=n,this.eventCount=e};l.prototype.popEvent=function(n,e){var r=this;if(this.eventCount==0)return null;for(var a=this.items.length;;a--){var i=this.items.get(a-1);if(i.selection){--a;break}}var s,p;e&&(s=this.remapping(a,this.items.length),p=s.maps.length);var o=n.tr,f,c,v=[],m=[];return this.items.forEach(function(u,g){if(!u.step){s||(s=r.remapping(a,g+1),p=s.maps.length),p--,m.push(u);return}if(s){m.push(new h(u.map));var y=u.step.map(s.slice(p)),M;y&&o.maybeStep(y).doc&&(M=o.mapping.maps[o.mapping.maps.length-1],v.push(new h(M,null,null,v.length+m.length))),p--,M&&s.appendMap(M,p)}else o.maybeStep(u.step);if(u.selection)return f=s?u.selection.map(s.slice(p)):u.selection,c=new l(r.items.slice(0,a).append(m.reverse().concat(v)),r.eventCount-1),!1},this.items.length,0),{remaining:c,transform:o,selection:f}};l.prototype.addTransform=function(n,e,r,a){for(var i=[],s=this.eventCount,p=this.items,o=!a&&p.length?p.get(p.length-1):null,f=0;f<n.steps.length;f++){var c=n.steps[f].invert(n.docs[f]),v=new h(n.mapping.maps[f],c,e),m=void 0;(m=o&&o.merge(v))&&(v=m,f?i.pop():p=p.slice(0,p.length-1)),i.push(v),e&&(s++,e=null),a||(o=v)}var u=s-r.depth;return u>_&&(p=B(p,u),s-=u),new l(p.append(i),s)};l.prototype.remapping=function(n,e){var r=new k;return this.items.forEach(function(a,i){var s=a.mirrorOffset!=null&&i-a.mirrorOffset>=n?r.maps.length-a.mirrorOffset:null;r.appendMap(a.map,s)},n,e),r};l.prototype.addMaps=function(n){return this.eventCount==0?this:new l(this.items.append(n.map(function(e){return new h(e)})),this.eventCount)};l.prototype.rebased=function(n,e){if(!this.eventCount)return this;var r=[],a=Math.max(0,this.items.length-e),i=n.mapping,s=n.steps.length,p=this.eventCount;this.items.forEach(function(u){u.selection&&p--},a);var o=e;this.items.forEach(function(u){var g=i.getMirror(--o);if(g!=null){s=Math.min(s,g);var y=i.maps[g];if(u.step){var M=n.steps[g].invert(n.docs[g]),I=u.selection&&u.selection.map(i.slice(o+1,g));I&&p++,r.push(new h(y,M,I))}else r.push(new h(y))}},a);for(var f=[],c=e;c<s;c++)f.push(new h(i.maps[c]));var v=this.items.slice(0,a).append(f).append(r),m=new l(v,p);return m.emptyItemCount()>R&&(m=m.compress(this.items.length-r.length)),m};l.prototype.emptyItemCount=function(){var n=0;return this.items.forEach(function(e){e.step||n++}),n};l.prototype.compress=function(n){n===void 0&&(n=this.items.length);var e=this.remapping(0,n),r=e.maps.length,a=[],i=0;return this.items.forEach(function(s,p){if(p>=n)a.push(s),s.selection&&i++;else if(s.step){var o=s.step.map(e.slice(r)),f=o&&o.getMap();if(r--,f&&e.appendMap(f,r),o){var c=s.selection&&s.selection.map(e.slice(r));c&&i++;var v=new h(f.invert(),o,c),m,u=a.length-1;(m=a.length&&a[u].merge(v))?a[u]=m:a.push(v)}}else s.map&&r--},this.items.length,0),new l(b.from(a.reverse()),i)};l.empty=new l(b.empty,0);function B(t,n){var e;return t.forEach(function(r,a){if(r.selection&&n--==0)return e=a,!1}),t.slice(e)}var h=function(n,e,r,a){this.map=n,this.step=e,this.selection=r,this.mirrorOffset=a};h.prototype.merge=function(n){if(this.step&&n.step&&!n.selection){var e=n.step.merge(this.step);if(e)return new h(e.getMap().invert(),e,this.selection)}};var w=function(n,e,r,a){this.done=n,this.undone=e,this.prevRanges=r,this.prevTime=a},_=20;function F(t,n,e,r){var a=e.getMeta(d),i;if(a)return a.historyState;e.getMeta(G)&&(t=new w(t.done,t.undone,null,0));var s=e.getMeta("appendedTransaction");if(e.steps.length==0)return t;if(s&&s.getMeta(d))return s.getMeta(d).redo?new w(t.done.addTransform(e,null,r,T(n)),t.undone,P(e.mapping.maps[e.steps.length-1]),t.prevTime):new w(t.done,t.undone.addTransform(e,null,r,T(n)),null,t.prevTime);if(e.getMeta("addToHistory")!==!1&&!(s&&s.getMeta("addToHistory")===!1)){var p=t.prevTime==0||!s&&(t.prevTime<(e.time||0)-r.newGroupDelay||!x(e,t.prevRanges)),o=s?E(t.prevRanges,e.mapping):P(e.mapping.maps[e.steps.length-1]);return new w(t.done.addTransform(e,p?n.selection.getBookmark():null,r,T(n)),l.empty,o,e.time)}else return(i=e.getMeta("rebased"))?new w(t.done.rebased(e,i),t.undone.rebased(e,i),E(t.prevRanges,e.mapping),t.prevTime):new w(t.done.addMaps(e.mapping.maps),t.undone.addMaps(e.mapping.maps),E(t.prevRanges,e.mapping),t.prevTime)}function x(t,n){if(!n)return!1;if(!t.docChanged)return!0;var e=!1;return t.mapping.maps[0].forEach(function(r,a){for(var i=0;i<n.length;i+=2)r<=n[i+1]&&a>=n[i]&&(e=!0)}),e}function P(t){var n=[];return t.forEach(function(e,r,a,i){return n.push(a,i)}),n}function E(t,n){if(!t)return null;for(var e=[],r=0;r<t.length;r+=2){var a=n.map(t[r],1),i=n.map(t[r+1],-1);a<=i&&e.push(a,i)}return e}function H(t,n,e,r){var a=T(n),i=d.get(n).spec.config,s=(r?t.undone:t.done).popEvent(n,a);if(!!s){var p=s.selection.resolve(s.transform.doc),o=(r?t.done:t.undone).addTransform(s.transform,n.selection.getBookmark(),i,a),f=new w(r?o:s.remaining,r?s.remaining:o,null,0);e(s.transform.setSelection(p).setMeta(d,{redo:r,historyState:f}).scrollIntoView())}}var C=!1,S=null;function T(t){var n=t.plugins;if(S!=n){C=!1,S=n;for(var e=0;e<n.length;e++)if(n[e].spec.historyPreserveItems){C=!0;break}}return C}var d=new O("history"),G=new O("closeHistory");function $(t){return t={depth:t&&t.depth||100,newGroupDelay:t&&t.newGroupDelay||500},new D({key:d,state:{init:function(){return new w(l.empty,l.empty,null,0)},apply:function(e,r,a){return F(r,a,e,t)}},config:t,props:{handleDOMEvents:{beforeinput:function(e,r){var a=r.inputType=="historyUndo"?K(e.state,e.dispatch):r.inputType=="historyRedo"?j(e.state,e.dispatch):!1;return a&&r.preventDefault(),a}}}})}function K(t,n){var e=d.getState(t);return!e||e.done.eventCount==0?!1:(n&&H(e,t,n,!1),!0)}function j(t,n){var e=d.getState(t);return!e||e.undone.eventCount==0?!1:(n&&H(e,t,n,!0),!0)}function q(t){var n=d.getState(t);return n?n.done.eventCount:0}export{q as a,$ as h,j as r,K as u};
